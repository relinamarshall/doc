---
layout:
  title:
    visible: false
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# 数据库管理篇

## 控制文件和日志文件

控制文件和日志文件是Oracle数据库中存储信息的重要文件。控制文件(Control File)主要用来存放数据库的名字、数据文件的位置等信息;日志文件(Log File)主要用来存放数据库中数据变化的操作。

### 控制文件与日志文件概述

控制文件和日志文件是数据库中两个主要的文件，没有控制文件数据库就无法启动，没有日志文件数据库的信息就无法完全恢复。

#### 什么是控制文件

控制文件是数据库中的一个二进制文件，它主要用来记录数据库的名字、数据库的数据文件存放的位置等信息。因此，有人也把控制文件比做数据库的心脏，那么心脏如果丢失或者损坏了，数据库就将不复存在。对于控制文件来说，保护是至关重要的。

每个数据库都存在控制文件，但是一个控制文件只属于一个数据库。这就像每个人都有身份证，但是一个身份证只属于一个人。控制文件在创建数据库时自动被创建，当数据库的信息发生改变时，控制文件也随之被改变，控制文件不能手动修改，只能由Oracle数据库本身自己来修改。控制文件在数据库启动和关闭时都要使用，如果没有控制文件，数据库将无法工作。那么，控制文件究竟是什么样的呢?使用下面的语句就可在数据字典中查看控制文件的信息:&#x20;

<pre class="language-sql"><code class="lang-sql"><strong>desc v$controlfile;
</strong></code></pre>

{% hint style="info" %}
desc命令需在SQLPlus中执行
{% endhint %}

```
 名称                                      是否为空? 类型
 ----------------------------------------- -------- -------
 STATUS                                    VARCHAR2(7)
 NAME                                      VARCHAR2(513)
 IS_RECOVERY_DEST_FILE                     VARCHAR2(3)
 BLOCK_SIZE                                NUMBER
 FILE_SIZE_BLKS                            NUMBER
```

{% hint style="info" %}
数据字典就是一组表和视图结构，存放有数据库所用的有关信息，对用户来说是一组只读的表。在数据字典前面加上V$，代表的是当前实例的动态视图。
{% endhint %}

#### 什么是日志文件

日志文件在Oralce数据库中分为**重做日志**文件和**归档日志**文件两种。其中，重做日志文件是Oracle数据库正常运行不可缺少的文件。重做日志文件(Redo Log File)主要记录了数据库操作的过程。在需要恢复数据库时，重做日志文件可以将日志从备份还原的数据库上再执行一遍，以达到数据库的最新状态。&#x20;

Oracle系统在运行时有归档模式和非归档模式两种模式。在非归档模式下，所有的日志文件都写在重做日志文件中，如果重做日志文件写满了，那么就把前面的日志文件覆盖了。例如,一共有a、b、c三个日志文件，在非归档模式下，如果a文件写满了，就开始写b文件，如果b文件也写满了，就开始写c文件，如果三个文件都写满了，就把a文件中的内容覆盖掉重新写入。在归档模式下，如果重做日志文件全部写满后,就把第一个重做日志文件写入归档日志文件中再把日志写到第一个重做日志文件中，使用归档日志的方式就可以方便以后做恢复操作。

```sql
desc v$logfile;
```

```
 名称                                      是否为空? 类型
 ----------------------------------------- -------- ----------
 GROUP#                                    NUMBER
 STATUS                                    VARCHAR2(7)
 TYPE                                      VARCHAR2(7)
 MEMBER                                    VARCHAR2(513)
 IS_RECOVERY_DEST_FILE                     VARCHAR2(3)
```

{% code lineNumbers="true" %}
```sql
desc v$database;

--name 数据库名字
--log_mode 日志模式
select name,log_mode from v$database;

--NAME               LOG_MODE
------------------ ------------------------
--ORCL               NOARCHIVELOG
```
{% endcode %}

{% hint style="info" %}
日志的状态NOARCHIVELOG指的是非归档模式，而ARCHIVELOG指的是归档模式。
{% endhint %}

### 初始控制文件

#### 控制文件的内容

控制文件的存放位置和状态可以从数据字典v$controlfile中查询

```sql
select name,status from v$controlfile;
```

从上面的查询结果中可以看出数据库的控制文件的扩展名是.ctl。在v$controlfile中status列一般都为空。每一个控制文件中都记录数据库的名称、创建数据库的时间、数据文件的名字及数据库存储的位置、重做日志文件的名字及位置、归档日志的信息、表空间信息、日志历史记录、备份信息、当前的日志序列号、最近检查点的信息等数据库使用信息。这些信息都是在操作数据库时自动写入到控制文件中的，而不是手动写入的。例如，在创建一个数据库时，控制文件中就会自动写入数据库的名称、数据库的创建时间等信息:在增加或者删除表空间时，表空间的信息也会自动写入控制文件中。&#x20;

控制文件的大小取决于创建数据库时所提供的参数信息，因此当添加数据库中的文件时，控制文件的大小保持不变。

> 创建数据库参数说明

| 参数名            | 说明                                                                                                              |
| -------------- | --------------------------------------------------------------------------------------------------------------- |
| MAXLOGFILES    | 指定数据库可建的日志文件组的最大值，Oracle利用这个值决定在控制文件中使用的空间大小，该空间用于存储日志文件名。其默认值、最大值和最小值的变化依赖于OS                                  |
| MAXLOGMEMBERS  | 指定日志文件组的最大的成员数。Oracle使用该值决定在控制文件中分配给日志文件名的空问大小。最小值为1，最大值和默认值是变化的，依于OS                                           |
| MAXLOGHISTORY  | 指定归档日志文件的最大数目，用于并行服务器选项的介质自动恢复。Oracle利用该值决定在控制文件中分配给归档日志文件名的空间大小。默认值为MAXINSTANCES值的倍数，是可变的，决定于OS。最大值受控制文件的大小所限制 |
| MAXDATAFILES   | 指定数据库可建立的最大数据文件数，其最小值为1，最大值和默认值决定于OS。实例可存取的数据文件的数目受初始参数DBFILES的限制                                               |
| MAXINSTANCES   | 指定可同时装配或打开该数据库的实例的最大数目。这个值优先于初始化参数INSTANCES、最小值为1，最大值和默认值依赖于OS                                                  |

#### 更新控制文件

当增加、重命名、删除一个数据文件时，Oracle服务器进程(Server Process)会立即更新控制文件以反映数据库结构的这种变化。每次在数据库的结构发生变化后，为了防止数据丢失都要备份控制文件。按照各进程分工不同分别把数据库的更改后信息写入到控制文件中:日志写入进程(LGWR)负责把当前日志序列号记录到控制文件中，校验点进程(CKPT)负责把校验点的信息记录到控制文件中，归档进程负责把归档日志的信息记录到控制文件中。 通常情况下，数据库管理员会使用镜像来管理控制文件，把每个控制文件分布到不同的物理磁盘，发生灾难时，即使其中一个控制文件损坏，数据也不会丢失，也不会使整个数据库陷于瘫痪。

{% hint style="info" %}
当打开数据库提示“文件比控制文件更新一旧的控制文件”，此时的问题就是数据文件里面的控制文件序列号比控制文件的高，那么这个问题的出现可能是更改控制文件的位置所造成的。补救的方法可以用数据库中的日志文件重新创建一下控制文件。
{% endhint %}

### 控制文件的多路复用

控制文件在数据库中的作用是不可比拟的。保护控制文件实际就是在保护数据库。Oracle的多路复用的特性就可以帮助数据库管理员保护好控制文件。多路复用的特性可以把控制文件的副本创建到不同的磁盘上，这样即使一个磁盘发生故障，Oracle仍然可以从其他磁盘上恢复，从而达到保护数据库的作用。

#### init.ora多路复用控制文件

可以在数据库初始化文件中修改控制文件存放的位置，init.ora就是数据库初始化文件，它是在创建数据库时自动创建的。要修改init.ora，首先要找到它的存放位置，这个文件存储在安装文件目录下的`oracle\admin\orcl\pfile`里面。在修改init.ora文件之前，通过复制把控制文件复制到不同的位置，然后再修改init.ora中的control\_files参数。

{% code title="" overflow="wrap" lineNumbers="true" %}
```
##############################################################################
# Copyright (c) 1991, 2001, 2002 by Oracle Corporation
##############################################################################
 
###########################################
# Shared Server
###########################################
dispatchers="(PROTOCOL=TCP) (SERVICE=orclXDB)"
 
###########################################
# Miscellaneous
###########################################
compatible=11.2.0.0.0
diagnostic_dest=F:\oracle
memory_target=4972347392
 
###########################################
# Security and Auditing
###########################################
audit_file_dest=F:\oracle\admin\orcl\adump
audit_trail=db
remote_login_passwordfile=EXCLUSIVE
 
###########################################
# Database Identification
###########################################
db_domain=""
db_name=orcl
 
###########################################
# File Configuration
###########################################
control_files=("F:\oracle\oradata\orcl\control01.ctl", "F:\oracle\flash_recovery_area\orcl\control02.ctl")
db_recovery_file_dest=F:\oracle\flash_recovery_area
db_recovery_file_dest_size=4102029312
 
###########################################
# Cursors and Library Cache
###########################################
open_cursors=300
 
###########################################
# System Managed Undo and Rollback Segments
###########################################
undo_tablespace=UNDOTBS1
 
###########################################
# Processes and Sessions
###########################################
processes=150
 
###########################################
# Cache and I/O
###########################################
db_block_size=8192
```
{% endcode %}

按照现有的control\_files形式进行修改，在修改时需要注意的是每一个控制文件之间是通过逗号分隔的，并且每一个控制文件都是用双引号括起来的。另外，在进行控制文件路径修改之前，最好把控制文件复制一份保存，以免数据库无法启动。

#### SPFILE多路服用控制文件

使用SPFILE方式实现多路复用控制文件的原理和修改init.ora初始化参数的文件中control\_files参数是一样的，只是修改方法不同。只需要在SQLPlus中写语句就可以完成control files参数的修改。

> 修改control\_files参数

<pre class="language-sql"><code class="lang-sql">ALTER system SET
<strong>    control_files='文件路径1','文件路径2','文件路径n'
</strong>    scope=spfile;
</code></pre>

> 关闭数据库

在数据库打开时,数据库中的任何文件都是无法操作的。关闭数据库命令如下:

```sql
shutdown immediate;
```

> 在DOS下复制文件到指定位置

在DOS窗口下使用复制命令在指定位置增加一个控制文件。复制命令语法如下:

```powershell
copy 旧文件, 新文件
```

> 启动数据库实例并验证

在文件复制完成后，使用startup重新启动数据库的实例。在数据库字典controlfile中重新查询现存的控制文件。

```sql
select name,status from v$controlfile;
```

{% hint style="info" %}
在Oracle中的控制文件个数不能少于2个;复制文件时一定要使用命令复制，否则数据库实例无法重新启动。
{% endhint %}

### 创建控制文件

控制文件在数据库中的作用前面已经讲过了，但是无论怎么保护都有可能出现控制文件丢 失和损坏的问题。本节将学习创建控制文件。控制文件在创建数据库时就自动创建了,并且在配置文件`init.ora`中已经记录了文件的路径。前面已经学习过控制文件记录的内容以及控制文件的重要性，控制文件一般情况下是不需要手工创建的。只有在两种情况下才考虑用手工的方式来创建控制文件，

* 一种是当控制文件全部损坏，无法恢复时
* 一种是需要永久地修改数据库的参数设置时

因为手工创建控制文件会出现一些无法预计的问题，只能说是一种补救办法。

> 手工创建控制文件

手工创建控制文件分为找原有的数据文件和重做日志的路径、关闭数据库、创建新的控制 文件、修改init.ora中controlfiles参数、验证控制文件5个步骤。

> 找原有的数据文件和重做日志的路径

数据文件和重做日志信息可以通过两种途径获取，一种方法是当控制文件没有损坏时，从控制文件中直接获取:一种方法是控制文件损坏了，从数据字典`v$datafile`中获取数据文件的信息，从数据字典`v$logfile`中获取日志文件的信息。前面的两种途径都是在数据库能够正常启动时使用的方法，如果数据库不能够正常启动，那么此时就需要根据系统提供的错误信息来查找原因。在创建新的控制文件并且使用它打开数据库之后，Oracle会对数据字典和控制文件的内容进行检查。如果发现数据字典包含了某个数据文件而控制文件中没有列出这个数据文件，Oracle数据库就会报错。数据库管理员就只能凭借这些信息来判断是否缺少必要的数据文件，一步一步查找直到找到真正的数据文件。

本例是在数据库能正常启动的情况下，通过datafile和logfile数据字典分别获得数据文件列表和日志文件列表。

<pre class="language-sql"><code class="lang-sql"><strong>--数据文件
</strong><strong>select name from v$datafile;
</strong></code></pre>

```sql
--日志文件
select member from v$logfile;
```

> 关闭数据库

在创建控制文件之前要关闭数据库，最好是正常关闭数据库。采用正常模式关闭，可以减少数据库重新启动过程中可能出现的问题。为保证数据库的安全，在关闭数据库后，应该把数据库的日志文件、数据文件、参数文件等备份到其他磁盘上。关闭数据库使用如下语句:&#x20;

```sql
shutdown immediate;
```

> 创建新的控制文件

在创建新的控制文件之前，最好把原来的控制文件备份到其他位置，这样创建的效果比较明显。此外，还要启动一个数据库的实例，这个数据库实例是安装数据库时自带的。

启动实例后就可以创建控制文件了，在创建控制文件时就需要用到日志文件和数据文件的列表。创建控制文件的语句如下:

{% code lineNumbers="true" %}
```sql
create controlfile
reuse database "数据库实例名" noresetlogs //是否重做日志或重命名数据库 noarchivelog//归档状态
maxlogfiles   //最大日志文件大小
maxlogmembers //日志文件组的成员数
maxinstances  //最大实例的个数
maxloghistory //最大历史日志文件个数
logfile       //日志文件
group1        "日志文件的路径1"   size   日志文件的大小，
...
Groupn        "日志文件的路径n'   size   日志文件的大小
datafile      //数据文件
'路径1'
...
'路径n'
Character set we8dec
```
{% endcode %}

在创建控制文件时如果不需要重做日志文件和重命名数据库，就使用noresetogs，否则就使用resetlogs;在创建控制文件时也可以设置归档状态，如果设置为noarchivelog，则指非归档状态，若设置为archivelog，则是归档状态。

> 修改init.ora中controlfiles参数

使用前面讲过的spfile方法，修改init.ora中的参数controlfiles。

> 验证控制文件

重启数据库后，查询v$controlfile数据字典，检查控制文件是否全部正确加载。如果数据库启动不了，可以重启数据库服务。

至此，控制文件创建成功。

### 日志文件的管理

#### 新建日志文件组

创建日志文件组是每一个数据库管理员必须要掌握的技能，日志文件组能够帮助数据库管理员管理日志文件。

{% code lineNumbers="true" %}
```sql
ALTER DATABASE [database_name]
ADD LOGFILE GROUP n
filename SIZE m

【语法说明】
database_name:要修改的数据库名，省略该项表示当前的数据库。
n:创建重组日志组的组号，组号在重做日志组中都是唯一的。
filename:日志文件组存储的位置。
m:日志文件组的大小，默认的大小是50MB。
```
{% endcode %}

#### 添加日志文件到组中

日志文件组创建完成后，一个日志文件组中可以包含多个日志文件，至少含有一个日志文件。

{% code lineNumbers="true" %}
```sql
ALTER DATABASE [database_name]
ADD LOGFILE MEMBER
filename TO GROUP n

【语法说明】
database_name:数据库的名称，默认是当前的数据库。
filename:日志文件的路径。
n:日志文件填人的组号。
```
{% endcode %}

#### 删除日志文件或组

> 删除日志文件组

{% code lineNumbers="true" %}
```sql
ALTER DATABASE [database_name]
DROP LOGFILE
GROUP n

n代表的是日志文件组的组号。
```
{% endcode %}

> 删除日志文件

{% code lineNumbers="true" %}
```sql
ALTER DATABASE [database_name]
DROP LOGFILE MEMBER
filename

filename是指日志文件的名字，包括路径。
```
{% endcode %}

#### 查询日志文件或组

> 查询日志文件组

{% code lineNumbers="true" %}
```sql
select * from v$log
```
{% endcode %}

> 查询日志文件

{% code lineNumbers="true" %}
```sql
select * from v$logfile;
```
{% endcode %}

## 表空间管理

### 表空间概述

#### 相关概念

#### 默认表空间

### 管理表空间

#### 创建表空间

#### 重命名表空间

#### 设置表空间读写状态

#### 设置表空间可用状态

#### 建立大文件表空间

#### 删除表空间

### 管理临时表空间

#### 建立临时表空间

#### 查询临时表空间

#### 创建临时表空间组

#### 查询临时表空间组

#### 删除临时表空间组

### 数据文件管理

#### 移动数据文件

#### 删除数据文件

### 小结

## 数据库安全性管理

### 用户管理

#### 什么是用户

#### 创建用户

#### 修改用户

#### 删除用户

### 授权管理

#### 什么是权限

#### 授权权限

#### 撤销权限

#### 查询用户权限

### 角色管理

#### 什么是角色

#### 创建角色

#### 设置角色

#### 修改角色

#### 删除角色

#### 查询角色

### 概要文件Profile

#### 什么是Profile

#### 创建Profile

#### 修改Profile

#### 删除Profile

#### 查询Profile

### 小结

## 备份恢复

### 数据库备份与恢复

#### 什么是数据库备份

#### 什么是数据库恢复

### 物理备份和恢复数据库

#### 对数据库进行脱机备份

#### 对数据库进行联机备份

### 逻辑备份和恢复数据库

#### 逻辑到处数据

#### 逻辑导入数据

### 小结

## RMAN工具

### RMAN概述

#### RMAN的特点

#### 与RMAN有关的概念

### 使用恢复目录

#### 创建恢复目录

#### 使用RMAN连接

#### 在恢复目录中注册数据库

### 通道分配

#### 什么是通道分配

#### 手动通道分配

#### 自动通道分配

### 备份集

#### 什么是备份集

#### BACKUP的使用

### 从备份中恢复

#### 使用RESTORE还原

#### 使用RECOVER恢复

### 小结



